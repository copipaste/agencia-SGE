<div class="container mt-4">
  <div class="page-header">
    <h2>{{ isEditMode ? 'Editar Venta' : 'Nueva Venta' }}</h2>
  </div>

  <div *ngIf="loading" class="text-center">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
  </div>

  <form *ngIf="!loading" (ngSubmit)="onSubmit()" #ventaForm="ngForm">
    <div class="form-section">
      <h5 class="section-title">
        <i class="bi bi-person-circle"></i> Información General
      </h5>
      
      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="cliente" class="form-label">Cliente *</label>
          <select class="form-select" id="cliente" name="clienteId" [(ngModel)]="venta.clienteId" required [disabled]="isEditMode">
            <option value="">Seleccione un cliente</option>
            <option *ngFor="let cliente of clientes" [value]="cliente.id">
              {{ getClienteNombre(cliente) }}
            </option>
          </select>
        </div>

        <div class="col-md-6 mb-3">
          <label for="agente" class="form-label">Agente *</label>
          <select class="form-select" id="agente" name="agenteId" [(ngModel)]="venta.agenteId" required [disabled]="isEditMode">
            <option value="">Seleccione un agente</option>
            <option *ngFor="let agente of agentes" [value]="agente.id">
              {{ getAgenteNombre(agente) }}
            </option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="estado" class="form-label">Estado *</label>
          <select class="form-select" id="estado" name="estadoVenta" [(ngModel)]="venta.estadoVenta" required>
            <option value="Pendiente">Pendiente</option>
            <option value="Confirmada">Confirmada</option>
            <option value="Cancelada">Cancelada</option>
          </select>
        </div>

        <div class="col-md-6 mb-3">
          <label for="metodoPago" class="form-label">Método de Pago *</label>
          <select class="form-select" id="metodoPago" name="metodoPago" [(ngModel)]="venta.metodoPago" required>
            <option value="Efectivo">Efectivo</option>
            <option value="Tarjeta">Tarjeta</option>
            <option value="Transferencia">Transferencia</option>
          </select>
        </div>
      </div>
    </div>

    <div class="detalles-section">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h4>
          <i class="bi bi-list-check"></i> Detalles de la Venta
        </h4>
        <button type="button" class="btn btn-success" (click)="addDetalle()">
          <i class="bi bi-plus-circle"></i> Agregar Detalle
        </button>
      </div>

    <div *ngFor="let detalle of detalles; let i = index" class="card mb-3 detalle-card">
      <div class="card-body">
        <div class="detalle-header" *ngIf="detalles.length > 1">
          <span class="detalle-number">Detalle #{{ i + 1 }}</span>
          <button type="button" class="btn btn-sm btn-danger" (click)="removeDetalle(i)">
            <i class="bi bi-trash"></i> Eliminar
          </button>
        </div>
        
        <div class="row align-items-end">
          <div class="col-lg-2 col-md-3 mb-3">
            <label class="form-label">Tipo *</label>
            <select class="form-select" [(ngModel)]="detalle.tipo" [name]="'tipo-' + i" (change)="onTipoChange(detalle)" required>
              <option value="servicio">Servicio</option>
              <option value="paquete">Paquete</option>
            </select>
          </div>

          <div class="col-lg-4 col-md-5 mb-3">
            <label class="form-label" *ngIf="detalle.tipo === 'servicio'">Servicio *</label>
            <label class="form-label" *ngIf="detalle.tipo === 'paquete'">Paquete *</label>
            
            <select class="form-select" *ngIf="detalle.tipo === 'servicio'" 
                    [(ngModel)]="detalle.servicioId" [name]="'servicioId-' + i" 
                    (change)="onItemChange(detalle)" required>
              <option value="">Seleccione un servicio</option>
              <option *ngFor="let servicio of servicios" [value]="servicio.id">
                {{ servicio.nombreServicio }} - {{ servicio.precioVenta | currency }}
              </option>
            </select>

            <select class="form-select" *ngIf="detalle.tipo === 'paquete'" 
                    [(ngModel)]="detalle.paqueteId" [name]="'paqueteId-' + i" 
                    (change)="onItemChange(detalle)" required>
              <option value="">Seleccione un paquete</option>
              <option *ngFor="let paquete of paquetes" [value]="paquete.id">
                {{ paquete.nombrePaquete }} - {{ paquete.precioTotalVenta | currency }}
              </option>
            </select>
          </div>

          <div class="col-lg-2 col-md-4 col-sm-4 mb-3">
            <label class="form-label">Cantidad *</label>
            <input type="number" class="form-control" [(ngModel)]="detalle.cantidad" [name]="'cantidad-' + i" 
                   (ngModelChange)="onCantidadChange(detalle)" min="1" required>
          </div>

          <div class="col-lg-2 col-md-6 col-sm-4 mb-3">
            <label class="form-label">Precio Unit. *</label>
            <input type="number" class="form-control" [(ngModel)]="detalle.precioUnitarioVenta" [name]="'precio-' + i" 
                   (ngModelChange)="onPrecioChange(detalle)" min="0" step="0.01" required>
          </div>

          <div class="col-lg-2 col-md-6 col-sm-4 mb-3">
            <label class="form-label">Subtotal</label>
            <input type="text" class="form-control subtotal-input" [value]="detalle.subtotal | currency" readonly>
          </div>
        </div>
      </div>
    </div>
    </div>

    <div class="total-section">
      <div class="total-display">
        <span class="total-label">Monto Total:</span>
        <span class="total-amount">{{ venta.montoTotal | currency }}</span>
      </div>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn btn-primary" [disabled]="!ventaForm.form.valid || loading">
        <span *ngIf="loading" class="spinner-border spinner-border-sm me-1"></span>
        <i class="bi bi-check-circle"></i> {{ isEditMode ? 'Actualizar' : 'Crear' }}
      </button>
      <button type="button" class="btn btn-secondary" (click)="cancel()">
        <i class="bi bi-x-circle"></i> Cancelar
      </button>
    </div>
  </form>
</div>
